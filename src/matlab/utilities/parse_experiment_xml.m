%% parse experiment info (fast-z or single-plane? if single-plane, is frame
% averaging used?)

function s = parse_experiment_xml(exml)
    thorimage_version = get_xml_software_version(exml);
    
    if thorimage_version(1)==4
        % galvo-res 
        scope = "galvo-res";
        fs0 = exml.LSM(1).frameRateAttribute; 

        num_frames = exml.Streaming(1).framesAttribute;
        num_timepoints = exml.Timelapse(1).timepointsAttribute;
        fast_z = exml.Streaming(1).zFastEnableAttribute;

        if fast_z == 0 % single plane
            num_zsteps = 1;
            if exml.LSM(1).averageModeAttribute == 1 % frame averaging is used
                average_num = exml.LSM(1).averageNumAttribute;
            elseif exml.LSM(1).averageModeAttribute == 0 % no frame averaging 
                average_num = 1;
            end
            fs = fs0/average_num;
            s = struct('scope', scope,...
                'fs0', fs0,...
                'fs', fs,...
                'num_frames', num_frames',...
                'num_timepoints', num_timepoints,...
                'fast_z', fast_z,...
                'num_zsteps', num_zsteps,...
                'flyback_frames', 0,...
                'total_planes', 1,...
                'average_num', average_num);

        elseif fast_z == 1 % fast-z scan
            num_zsteps = exml.ZStage(1).stepsAttribute;
            flyback_frames = exml.Streaming.flybackFramesAttribute;
            total_planes = num_zsteps + flyback_frames;
            average_num = 1;
            fs = fs0/total_planes;
            s = struct('scope', scope,...
                'fs0', fs0,...
                'fs', fs,...
                'num_frames', num_frames',...
                'num_timepoints', num_timepoints,...
                'fast_z', fast_z,...
                'num_zsteps', num_zsteps,...
                'flyback_frames', flyback_frames,...
                'total_planes', total_planes,...
                'average_num', average_num);
        end
    else
        % galvo-galvo
        scope = "galvo-galvo";
        fs0 = exml.LSM.frameRateAttribute; 
        
        num_frames = exml.Streaming.framesAttribute;
        num_timepoints = exml.Timelapse.timepointsAttribute;
        fast_z = exml.Streaming.zFastEnableAttribute;
        
        if fast_z == 0 % single plane
            num_zsteps = 1;
            if exml.LSM.averageModeAttribute == 1 % frame averaging is used
                average_num = exml.LSM.averageNumAttribute;
            elseif exml.LSM.averageModeAttribute == 0 % no frame averaging 
                average_num = 1;
            end
            fs = fs0/average_num;
            s = struct('scope', scope,...
                'fs0', fs0,...
                'fs', fs,...
                'num_frames', num_frames',...
                'num_timepoints', num_timepoints,...
                'fast_z', fast_z,...
                'num_zsteps', num_zsteps,...
                'average_num', average_num);

        elseif fast_z == 1 % fast-z scan

        end
    end
end